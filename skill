#!/bin/bash
# Skill Runner - Downloads ticket and prepares context for skills
# Usage: ./skill <skill-name> <ticket-id>
# Example: ./skill SSO_PRD PROD-761

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

if [ -z "$1" ] || [ -z "$2" ]; then
    echo "Usage: skill <skill-name> <ticket-id>"
    echo ""
    echo "Available skills:"
    ls -1 "$SCRIPT_DIR/.claude/skills/" 2>/dev/null | grep -v "^_"
    echo ""
    echo "Example: skill SSO_PRD PROD-761"
    exit 1
fi

SKILL_NAME="$1"
TICKET_ID="$2"

# Check if skill exists
if [ ! -d "$SCRIPT_DIR/.claude/skills/$SKILL_NAME" ]; then
    echo "Error: Skill '$SKILL_NAME' not found"
    echo ""
    echo "Available skills:"
    ls -1 "$SCRIPT_DIR/.claude/skills/" 2>/dev/null | grep -v "^_"
    exit 1
fi

# Download ticket if not already downloaded
TICKET_DIR="$SCRIPT_DIR/tickets/$TICKET_ID"
if [ ! -d "$TICKET_DIR" ]; then
    echo "Downloading ticket $TICKET_ID..."
    "$SCRIPT_DIR/jira" "$TICKET_ID"
fi

# Show the context files available
echo ""
echo "=================================================="
echo "Ready to use skill: $SKILL_NAME"
echo "Ticket context: $TICKET_ID"
echo "=================================================="
echo ""
echo "Context files available:"
echo "  - tickets/$TICKET_ID/README.md"
echo "  - tickets/$TICKET_ID/raw_data.json"
ls "$TICKET_DIR/attachments/" 2>/dev/null | head -5 | while read f; do
    echo "  - tickets/$TICKET_ID/attachments/$f"
done
echo ""
echo "To use in Claude Code CLI, run:"
echo ""
echo "  /$SKILL_NAME"
echo ""
echo "Then tell Claude to use the ticket context:"
echo "  'Generate PRD for $TICKET_ID using context from tickets/$TICKET_ID/'"
echo ""
